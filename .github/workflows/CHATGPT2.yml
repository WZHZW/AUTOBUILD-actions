name: OpenWrt Compile

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Setup OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cp ../.config .config
        env:
          CONFIG_TARGET_x86_64: y # Select the target architecture
      - name: Compile OpenWrt
        run: |
          cd openwrt
          make -j$(nproc) V=s
      - name: Upload Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./openwrt/bin/targets/$CONFIG_TARGET_x86_64/generic/openwrt-$CONFIG_VERSION-x86-64-generic-squashfs-combined.img.gz
          asset_name: openwrt-$CONFIG_VERSION-x86-64-generic-squashfs-combined.img.gz
          asset_content_type: application/octet-stream
        env:
          CONFIG_VERSION: ${{ env.CONFIG_VERSION }} # Set version number
